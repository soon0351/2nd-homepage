<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI English Master (SDK Version)</title>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <style>
        :root { --primary: #4285F4; --bg: #f0f4f8; --card: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: var(--bg); color: #333; }
        
        /* Layout */
        .api-box { background: #2c3e50; padding: 20px; border-radius: 12px; color: white; margin-bottom: 20px; text-align: center; }
        .api-box input { padding: 10px; width: 60%; border-radius: 5px; border: none; font-size: 16px; }
        .api-box button { padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 16px; }
        
        .container { background: var(--card); padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .tabs { display: flex; margin-bottom: 20px; gap: 10px; }
        .tab { flex: 1; padding: 12px; background: #e0e0e0; text-align: center; cursor: pointer; border-radius: 8px; font-weight: bold; }
        .tab.active { background: var(--primary); color: white; }
        .content { display: none; }
        .content.active { display: block; }
        
        /* UI Components */
        .chat-window { height: 350px; overflow-y: auto; background: #fff; border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px; margin-bottom: 10px; }
        .msg { padding: 10px 15px; margin: 5px 0; border-radius: 15px; max-width: 80%; display: table; }
        .msg.ai { background: #e3f2fd; border-bottom-left-radius: 0; }
        .msg.user { background: #4285F4; color: white; margin-left: auto; border-bottom-right-radius: 0; }
        
        .input-area { display: flex; gap: 10px; }
        .input-area input { flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; }
        .btn { padding: 12px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }

        .loading { font-style: italic; color: #666; font-size: 0.9em; }
        
        /* Speaking Card */
        .story-card { background: #fffde7; padding: 15px; border: 1px solid #fbc02d; border-radius: 8px; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="api-box">
    <h3>ğŸ”‘ Google AI Studio Key</h3>
    <input type="password" id="apiKey" placeholder="sk-..." />
    <button id="saveKeyBtn">í‚¤ ì €ì¥ ë° ì´ˆê¸°í™”</button>
    <p id="statusMsg" style="margin-top:10px; font-size:0.9em; color:#bbb;">í‚¤ë¥¼ ì…ë ¥í•˜ê³  ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
</div>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h2>ğŸ‡ºğŸ‡¸ Official SDK Tutor</h2>
        <select id="levelSelect" style="padding:5px;">
            <option value="Beginner">ê¸°ì´ˆ (Beginner)</option>
            <option value="Intermediate">ì¤‘ê¸‰ (Intermediate)</option>
            <option value="Advanced">ê³ ê¸‰ (Advanced)</option>
        </select>
    </div>

    <div class="tabs">
        <div class="tab active" data-target="reading">1. ì½ê¸° (Reading)</div>
        <div class="tab" data-target="writing">2. ì“°ê¸° (Writing)</div>
        <div class="tab" data-target="speaking">3. ë§í•˜ê¸° (Speaking)</div>
    </div>

    <div id="reading" class="content active">
        <div style="text-align: center; padding: 20px;">
            <h1 id="read-text" style="color:#2c3e50;">Sentence will appear here.</h1>
            <br>
            <button class="btn" id="read-listen-btn">ğŸ”Š ë“£ê¸°</button>
            <button class="btn" id="read-gen-btn">ğŸ”„ ìƒˆ ë¬¸ì¥ ìƒì„±</button>
        </div>
    </div>

    <div id="writing" class="content">
        <button class="btn" id="write-start-btn" style="width:100%; margin-bottom:10px; background:#27ae60;">ì‘ë¬¸ ì‹œì‘ (ì§ˆë¬¸ ë°›ê¸°)</button>
        <div class="chat-window" id="write-chat"></div>
        <div class="input-area">
            <input type="text" id="write-input" placeholder="ì˜ì–´ë¡œ ë‹µë³€..." />
            <button class="btn" id="write-send-btn">ì „ì†¡</button>
        </div>
    </div>

    <div id="speaking" class="content">
        <div id="speak-setup">
            <button class="btn" id="speak-start-btn" style="width:100%; padding:20px; background:#e74c3c; font-size:1.2em;">ğŸ¬ ì£¼ì œ & ìŠ¤í† ë¦¬ ìƒì„± (ì„¸ì…˜ ì‹œì‘)</button>
        </div>
        <div id="speak-interface" style="display:none; margin-top:10px;">
            <div class="story-card">
                <strong>Topic:</strong> <span id="story-topic"></span><br><br>
                <div id="story-body" style="font-style:italic;"></div>
                <hr>
                <strong>Vocab:</strong> <span id="story-vocab"></span>
            </div>
            <div class="chat-window" id="speak-chat" style="height:250px;"></div>
            <div class="input-area">
                <input type="text" id="speak-input" placeholder="ëŒ€ë‹µ ì…ë ¥ (ë˜ëŠ” 'stop')..." />
                <button class="btn" id="speak-send-btn">ì „ì†¡</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    let genAI = null;
    let model = null;
    let apiKey = "";
    
    // ìƒíƒœ ë³€ìˆ˜
    let currentLevel = "Beginner";
    let writeHistory = [];
    let speakHistory = [];

    // --- 1. ì´ˆê¸°í™” ë° í‚¤ ì €ì¥ ---
    document.getElementById('saveKeyBtn').addEventListener('click', async () => {
        const input = document.getElementById('apiKey').value.trim();
        const msg = document.getElementById('statusMsg');
        
        if (!input.startsWith('sk-') || input.length < 10) {
            alert('ì˜¬ë°”ë¥¸ í‚¤ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. (sk-ë¡œ ì‹œì‘)');
            return;
        }

        apiKey = input;
        try {
            genAI = new GoogleGenerativeAI(apiKey);
            // â˜… ì¤‘ìš”: ëª¨ë¸ì„ 1.5-flashë¡œ ê³ ì • (ê°€ì¥ í˜¸í™˜ì„± ì¢‹ìŒ)
            model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
            
            msg.innerText = "âœ… ì—°ê²° ì„±ê³µ! SDKê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.";
            msg.style.color = "#4caf50";
            alert("API í‚¤ê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ë³´ì„¸ìš”!");
        } catch (e) {
            alert("ì´ˆê¸°í™” ì˜¤ë¥˜: " + e.message);
        }
    });

    // --- ê³µí†µ: í…ìŠ¤íŠ¸ ì½ì–´ì£¼ê¸° ---
    function speakTTS(text) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "en-US";
        u.rate = currentLevel === "Beginner" ? 0.8 : 1.0;
        window.speechSynthesis.speak(u);
    }

    // --- ê³µí†µ: ì±„íŒ… UI ì¶”ê°€ ---
    function addMsg(boxId, text, type) {
        const box = document.getElementById(boxId);
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerText = text;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    // --- ê³µí†µ: AI í˜¸ì¶œ í•¨ìˆ˜ (ì•ˆì „ì¥ì¹˜ í¬í•¨) ---
    async function askAI(promptText) {
        if (!model) { alert("ë¨¼ì € ìƒë‹¨ì— API í‚¤ë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”."); return null; }
        try {
            const result = await model.generateContent(promptText);
            const response = await result.response;
            return response.text();
        } catch (e) {
            console.error(e);
            alert("AI í†µì‹  ì˜¤ë¥˜: " + e.message);
            return null;
        }
    }

    // --- íƒ­ ì „í™˜ ë¡œì§ ---
    document.querySelectorAll('.tab').forEach(t => {
        t.addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.content').forEach(x => x.classList.remove('active'));
            t.classList.add('active');
            document.getElementById(t.dataset.target).classList.add('active');
        });
    });

    document.getElementById('levelSelect').addEventListener('change', (e) => currentLevel = e.target.value);


    // ==========================================
    // 1. ì½ê¸° (Reading)
    // ==========================================
    document.getElementById('read-gen-btn').addEventListener('click', async () => {
        const btn = document.getElementById('read-gen-btn');
        btn.innerText = "ìƒì„± ì¤‘..."; btn.disabled = true;

        const prompt = `Create one single simple English sentence for a ${currentLevel} learner. No translation. Just the English text.`;
        const text = await askAI(prompt);
        
        if (text) {
            const clean = text.trim();
            document.getElementById('read-text').innerText = clean;
            speakTTS(clean);
        }
        btn.innerText = "ğŸ”„ ìƒˆ ë¬¸ì¥ ìƒì„±"; btn.disabled = false;
    });

    document.getElementById('read-listen-btn').addEventListener('click', () => {
        speakTTS(document.getElementById('read-text').innerText);
    });


    // ==========================================
    // 2. ì“°ê¸° (Writing)
    // ==========================================
    document.getElementById('write-start-btn').addEventListener('click', async () => {
        document.getElementById('write-chat').innerHTML = "";
        const prompt = `Act as an English tutor. Ask a random question in KOREAN suitable for a ${currentLevel} student to answer in English. Output ONLY the question.`;
        
        const text = await askAI(prompt);
        if(text) {
            addMsg('write-chat', text, 'ai');
            writeHistory = `System: You are a tutor. User level: ${currentLevel}.\nAI: ${text}\n`;
        }
    });

    document.getElementById('write-send-btn').addEventListener('click', async () => {
        const input = document.getElementById('write-input');
        const val = input.value;
        if(!val) return;
        
        addMsg('write-chat', val, 'user');
        input.value = "";
        
        writeHistory += `User: ${val}\n`;
        const prompt = `${writeHistory}\nTask: Check user's answer. Correct errors. Give feedback in Korean. Ask next question in Korean.`;
        
        const reply = await askAI(prompt);
        if(reply) {
            addMsg('write-chat', reply, 'ai');
            writeHistory += `AI: ${reply}\n`;
        }
    });


    // ==========================================
    // 3. ë§í•˜ê¸° (Speaking) - ìŠ¤í† ë¦¬ ëª¨ë“œ
    // ==========================================
    document.getElementById('speak-start-btn').addEventListener('click', async () => {
        const btn = document.getElementById('speak-start-btn');
        btn.innerText = "â³ ìŠ¤í† ë¦¬ë¥¼ ë§Œë“¤ê³  ìˆìŠµë‹ˆë‹¤..."; btn.disabled = true;

        const prompt = `
        1. Create a random topic for ${currentLevel} English learner.
        2. Write a short story (3-5 sentences) in English.
        3. Pick 3 difficult words.
        Output format:
        TOPIC: ...
        STORY: ...
        VOCAB: ...
        `;
        
        const res = await askAI(prompt);
        btn.innerText = "ğŸ¬ ì£¼ì œ & ìŠ¤í† ë¦¬ ìƒì„± (ì„¸ì…˜ ì‹œì‘)"; btn.disabled = false;

        if (res) {
            // íŒŒì‹±
            const topic = res.match(/TOPIC:\s*(.*)/i)?.[1] || "Random";
            const story = res.match(/STORY:\s*([\s\S]*?)VOCAB:/i)?.[1] || res;
            const vocab = res.match(/VOCAB:\s*(.*)/i)?.[1] || "";

            document.getElementById('story-topic').innerText = topic;
            document.getElementById('story-body').innerText = story;
            document.getElementById('story-vocab').innerText = vocab;

            document.getElementById('speak-setup').style.display = 'none';
            document.getElementById('speak-interface').style.display = 'block';

            // ëŒ€í™” ì‹œì‘
            const startPrompt = `Story: ${story}\nTask: Ask the user the first simple question about this story to start conversation.`;
            const firstQ = await askAI(startPrompt);
            if(firstQ) {
                addMsg('speak-chat', firstQ, 'ai');
                speakTTS(firstQ);
                speakHistory = `Story Context: ${story}\nAI: ${firstQ}\n`;
            }
        }
    });

    document.getElementById('speak-send-btn').addEventListener('click', async () => {
        const input = document.getElementById('speak-input');
        const val = input.value;
        if(!val) return;

        addMsg('speak-chat', val, 'user');
        input.value = "";

        if(val.includes("stop") || val.includes("ê·¸ë§Œ")) {
            addMsg('speak-chat', "Session finished. Good job!", 'ai');
            speakTTS("Session finished.");
            return;
        }

        speakHistory += `User: ${val}\n`;
        const prompt = `${speakHistory}\nTask: React naturally to user and ask a follow-up question about the story or their opinion. Keep it ${currentLevel} level.`;

        const reply = await askAI(prompt);
        if(reply) {
            addMsg('speak-chat', reply, 'ai');
            speakTTS(reply);
            speakHistory += `AI: ${reply}\n`;
        }
    });

</script>

</body>
</html>
